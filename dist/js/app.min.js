function isArray(a){return"[object Array]"===Object.prototype.toString.call(a)}function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}function isInt(a){return"number"==typeof a&&a%1==0}function isValidString(a){return"string"==typeof a&&""!==a}function isFunction(a){return a&&"[object Function]"===(new Object).toString.call(a)}function contains(a){if(arguments.length<2)throw new Error("Nothing to search for!");var b=Array.prototype.slice.call(arguments).slice(1);return b.every(function(b){return-1!==a.indexOf(b)})}function inherits(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b.prototype}function copy(a,b){b=b||{};for(var c in a)b[c]="object"==typeof a[c]?copy(b[c],a[c]):b[c]=a[c];return b}var RichHTMLElement=function(){function a(a){this.target=a}return a.prototype.getClasses=function(){return this.target.className.split(/\s+/)},a.prototype.hasClass=function(a){return-1!==this.getClasses().indexOf(a)},a.prototype.addClass=function(a){if(!this.hasClass(a)){var b=this.getClasses();b.push(a),this.target.className=b.join(" ")}},a.prototype.removeClass=function(a){if(this.hasClass(a)){var b=this.getClasses(),c=b.indexOf(a);b.splice(c,1),this.target.className=b.join(" ")}},a}(),Animation=function(){function a(a){if(!OPTIONS_COORDINATES.every(function(b){return isInt(a[b])}))throw new Error('key "'+key+'" should be an integer');if(!OPTIONS_DIMENSIONS.every(function(b){var c=a[b];return isInt(c)&&0!==c}))throw new Error('key "'+key+'" should be an integer and higher than zero');if(!isArray(a.delays)||!a.delays.every(isInt))throw new Error("delays should be an array of integers")}function b(b){b=copy(b,copy(d)),a(b);var c=this;for(e.forEach(function(a){c[a]=b[a]});this.length<this.delays.length;)this.delays.push(0);this.frame=0,this.delay=0}var c=16,d={x:0,y:0,offsetX:0,offsetY:0,width:c,height:c,length:1,delays:[]},e=["x","y","offsetX","offsetY","width","height","length","delays"];return OPTIONS_COORDINATES=e.slice(0,-4),OPTIONS_DIMENSIONS=e.slice(4,-1),b.prototype.next=function(){return this.delay<this.delays[this.frame]?this.delay+1>=this.delays[this.frame]&&this.frame+1>=this.length:(this.delay=0,this.frame++,this.frame>=this.length&&(this.frame=0),!1)},b}(),SpriteSheet=function(){function a(a,b){if(!isValidString(a))throw new Error("animation without name");check.animation(b)}function b(f,g,h,i){if(this.name=f,!isValidString(this.name))throw new Error("sprite sheet without a name");this.offsetX=g||0,this.offsetY=h||0,this.x=0,this.y=0,this.element=new RichHTMLElement(document.createElement("div")),this.index=0,this.flipped=!1,this.animation=i?i.initial:null,this.element.target.style.backgroundImage=c+f+d,this.element.addClass(e),i=i||{},this.addAnimation=function(b,c){return a(b,c),i[b]=c,i.initial=i.initial||b,this.animation=b,this.redraw(),this},this.getAnimation=function(a){return i[a||this.animation]},this.clone=function(){return new b(this.name,this.offsetX,this.offsetY,i)}}var c="url('dist/i/sprites/",d=".png')",e="stage__sprite",f=e+"_style_flipped";return b.prototype.getFrameWidth=function(){return this.getAnimation().width},b.prototype.getFrameHeight=function(){return this.getAnimation().height},b.prototype.step=function(){return this.getAnimation().next()},b.prototype.update=function(){var a=this.getAnimation(),b=2*(a.x+a.frame*a.width),c=a.y,d=this.element.target.style;d.left=Math.floor(2*this.x+2*this.offsetX).toString()+"px",d.top=Math.floor(2*this.y+2*this.offsetY).toString()+"px",d.backgroundPosition=-b.toString()+"px "+-c.toString()+"px"},b.prototype.redraw=function(){var a=this.element.target.style,b=this.getAnimation();b.frame=0;var c=2*b.width,d=2*b.height,e=2*(b.x+b.offsetX),f=2*(b.y+b.offsetY);a.width=c.toString()+"px"||"auto",a.height=d.toString()+"px"||"auto",a.zIndex=this.index,a.backgroundPosition=-e.toString()+"px "+-f.toString()+"px"},b.prototype.flip=function(){var a=this.element.hasClass(f);this.flipped&&a?this.element.removeClass(f):this.flipped||a||this.element.addClass(f),this.flipped=!this.flipped},b}(),Action=function(){function a(a,b,c){check.object(b),this.name=a,this.target=b,this.data=c}return a}(),GameObject=function(){function a(a){if(!isNumber(a))throw new Error("scroll value should be a number");if(0>a)throw new Error("scroll value cannot be lower than 0")}function b(a){if(!isInt(a))throw new Error("hit width should be an integer");if(0>a)throw new Error("hit width cannot be lower than 0")}function c(a,b){if(!isValidString(a))throw new Error("action receiver should have a valid name");if(!isFunction(b))throw new Error("action callback should be a function")}function d(d,h,i){this.sprite=d,this.scroll=h||0,check.sprite(this.sprite),a(this.scroll),i=i||0,b(i);var j={};this.getHitWidth=function(){return i?i:Math.floor(this.sprite.getFrameWidth()/2)},this.addActionListener=function(a,b){c(a,b),void 0!==j[a]&&console.warn('a receiver with name "'+a+'" already exists, overwriting'),j[a]=b},this.receiveAction=function(a){check.action(a);var b=j[a.name];b?b(a):console.error("Couldn't find an action listener for \""+a.name+'"')},this.getDeltaWidth=function(a){return a=a||1,e/a-Math.ceil(this.sprite.getFrameWidth()/a)},this.getDeltaHeight=function(a){return a=a||1,f/a-Math.ceil(this.sprite.getFrameHeight()/a)-g}}var e=320,f=112,g=6;return d.prototype.leftCornerReached=function(){return this.scroll<this.getDeltaWidth(2)},d.prototype.rightCornerReached=function(a){return this.scroll+this.getDeltaWidth(2)>=a},d.prototype.correctSprite=function(a,b){if(null!==b&&!(b instanceof d))throw new Error("invalid relative object");this.sprite.y=this.getDeltaHeight();var c=Math.floor(this.scroll+this.getDeltaWidth()-a)-1,e=Math.floor(this.scroll);this.sprite.x=b?b.leftCornerReached()||b.rightCornerReached(a)?b.rightCornerReached(a)?c:e:this.getDeltaWidth(2)-Math.floor(b.scroll-this.scroll):this.leftCornerReached()||this.rightCornerReached(a)?this.rightCornerReached(a)?c:e:this.getDeltaWidth(2),this.sprite.update()},d.prototype.createAction=function(a){if(!isValidString(a))throw new Error("action should have a name");return new Action(a,this)},d}(),DynamicObject=function(){"use strict";function a(a){if(!isNumber(a.step))throw new Error('velocity with invalid step"');if(!isNumber(a.step))throw new Error('velocity with invalid maximum"')}function b(c,f,g,h,i){b.superclass.constructor.apply(this,arguments),this.velocity={step:h||d,max:i||e,value:0},a(this.velocity)}var c=.6,d=.4,e=3;return inherits(b,GameObject),b.prototype.push=function(a,b){if(a=a||1,b=b||this.velocity.step,!isNumber(a))throw new Error('push with invalid factor"');if(!isNumber(b))throw new Error('push with invalid value"');b*=a;var c=this.velocity;c.value+=b,c.value=Math.min(c.max,Math.abs(c.value))*(Math.abs(c.value)/(c.value||1)),this.scroll-=c.value;var d=this.sprite.flipped;(0>a&&d||a>0&&!d)&&this.sprite.flip(),(this.scroll<0||this.scroll>this.bound)&&(this.scroll=Math.min(this.bound,Math.max(0,this.scroll)),c.value=0),this.correctAnimation()},b.prototype.wait=function(){this.velocity.value*=c,Math.abs(this.velocity.value)<.1&&(this.velocity.value=0),this.scroll-=this.velocity.value,this.correctAnimation()},b.prototype.correctAnimation=function(){var a=this.sprite.animation;Math.abs(this.velocity.value)<1&&"walk"===this.sprite.animation&&(this.sprite.animation="idle"),Math.abs(this.velocity.value)>=1&&"idle"===this.sprite.animation&&(this.sprite.animation="walk"),a!=this.sprite.animation&&this.sprite.redraw()},b}(),Room=function(){function a(a,b){for(var c=[],d=0;a>d;++d){{var e=document.createElement("div");1===a?b:b+"_"+d.toString()}e.style.backgroundImage=f+b+g,e.setAttribute("class",h),c.push(e)}return c}function b(a,b,c,d){if(!isValidString(a))throw new Error("Room without a name!");if(!isValidString(b))throw new Error("Room with invalid type");if(!isInt(c))throw new Error("Room with invalid width");if(!isInt(d))throw new Error("Room with invalid depth")}function c(c,f,g,h){this.name=c,this.type=f||e,this.width=g||d,this.depth=h||1,b(this.name,this.type,this.width,this.depth),this.width=Math.max(d,this.width),this.tiles=a(this.depth,this.type)}var d=320,e="base",f="url('dist/i/tiles/",g=".png')",h="background__tile";return c.prototype.updateTiles=function(a){return isInt(a)?void this.tiles.forEach(function(b,c,d){var e=2*-Math.floor(a/(d.length-c));b.style.backgroundPosition=e.toString()+"px 0px"}):new Error("offset should be an integer")},c}(),check=function(){function a(a,b){return function(c){if(!(c instanceof b))throw new Error("invalid",a)}}return{room:a("room",Room),object:a("object",GameObject),listOfObjects:function(a){if(!isArray(a)||isArray(a)&&0===a.length&&!a.every(function(a){return a instanceof GameObject}))throw new Error("invalid list of objects!")},animation:a("animation",Animation),sprite:a("sprite",SpriteSheet),action:a("action",Action)}}();!function(){function a(a){return 87===a||38===a?"up":68===a||39===a?"right":83===a||40===a?"down":65===a||37===a?"left":void 0}function b(b){var c=a(b.keyCode);-1===m.indexOf(c)&&m.push(c)}function c(b){var c=m.indexOf(a(b.keyCode));-1!==c&&m.splice(c,1)}function d(){var a=Array.prototype.slice.call(o.childNodes,0);r.forEach(function(b){b.correctSprite(q.width,b===s?null:s),b.sprite.step(),b.sprite.update();var c=b.sprite.x,d=b.sprite.y,e=b.sprite.getFrameWidth(),f=b.sprite.getFrameHeight(),g=0>c+e||c>=i||0>d+f||d>=j,h=b.sprite.element.target;g&&contains(a,h)?o.removeChild(h):g||contains(a,h)||o.appendChild(h)});var b=Math.floor(s.getDeltaWidth(2)),c=0;s.scroll+b>=q.width?c=q.width-2*b:s.scroll>=b&&(c=Math.floor(s.scroll)-b),q.updateTiles(c)}function e(){var a=m[m.length-1];switch(a){case"right":s.push(-1);break;case"left":s.push();break;case"down":t||g(s),s.wait();break;default:s.wait()}t=contains(m,"down"),d()}function f(a){var b=r.filter(function(b){var c=a.scroll>=b.scroll-b.getHitWidth(),d=a.scroll+a.getHitWidth()<=b.scroll+b.getHitWidth();return c&&d&&b!==a});return b[0]}function g(a){var b=f(a);b&&b.receiveAction(a.createAction("interact"))}function h(a,b){check.room(a),check.listOfObjects(b),q=a,r=b,s=b[0],s.sprite.index=1,r.forEach(function(b){b.bound=a.width,b.sprite.redraw()}),q.tiles.forEach(function(a){p.appendChild(a)}),o.appendChild(s.sprite.element.target)}var i=320,j=112,k=80,l={};l.hero=new SpriteSheet("hero").addAnimation("idle",new Animation({width:37,height:72})).addAnimation("walk",new Animation({x:37,width:37,height:72,length:16})),l.door=new SpriteSheet("door",0,-10).addAnimation("idle",new Animation({width:40,height:80}));var m=[],n=document.createElement("div"),o=document.createElement("div"),p=document.createElement("div");document.body.appendChild(n),n.setAttribute("id","screen"),n.setAttribute("tabindex",0),n.appendChild(o),n.appendChild(p),n.addEventListener("keydown",b),n.addEventListener("keyup",c),o.setAttribute("class","stage"),p.setAttribute("class","background");var q,r,s,t=!1;h(new Room("blank",null,840),[new DynamicObject(l.hero,740,8),new GameObject(l.door.clone(),40),new GameObject(l.door.clone(),400),new GameObject(l.door.clone(),780)]),setInterval(e,k)}();