function isDefined(a){return void 0!==a}function isBoolean(a){return a===!1||a===!0}function isArray(a){return"[object Array]"===Object.prototype.toString.call(a)}function isNumber(a){return"number"==typeof a&&!isNaN(parseFloat(a))&&isFinite(a)}function isInt(a){return"number"==typeof a&&a%1==0}function isValidString(a){return"string"==typeof a&&""!==a}function isFunction(a){return a&&"[object Function]"===(new Object).toString.call(a)}function parseBoolean(a){return"true"===a?!0:"false"===a?!1:null}function toCapital(a){return isValidString(a)?a.charAt(0).toUpperCase()+a.slice(1):a}function toCamelCase(a){if(!isValidString(a)||-1===a.indexOf("-"))return a;var b=a.split("-");return b[0]+b.slice(1).map(toCapital).join("")}function toArray(a){return Array.prototype.slice.call(a)}function contains(a){if(!isArray(a)||arguments.length<2)return!1;var b=toArray(arguments).slice(1);return b.every(function(b){return-1!==a.indexOf(b)})}function inherits(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b.prototype}function copy(a,b){b=b||{};for(var c in a)b[c]="object"==typeof a[c]?copy(b[c],a[c]):b[c]=a[c];return b}function check(a,b,c){return new Checker(a,b,c)}var RichHTMLElement=function(){function a(a){return e(a).is(d)}function b(a){return new d(a)}function c(b){return a(b)?b.source:b}function d(a){isValidString(a)&&(a=document.createElement(a)),e(a,"element").toBe(HTMLElement),this.source=a}var e=check.bind(null,"RichHTMLElement");return d.prototype.attr=function(a,b){return this.source.setAttribute(a,b),this},d.prototype.append=function(a){return this.source.appendChild(c(a)),this},d.prototype.prepend=function(a){var b=this.source.firstChild;return b?this.source.insertBefore(c(a),b):this.append(a),this},d.prototype.remove=function(b){return this.source.removeChild(a(b)?b.source:b),this},d.prototype.children=function(){return Array.prototype.slice.call(this.source.childNodes,0).map(b)},d.prototype.getClasses=function(){return this.source.className.split(/\s+/)},d.prototype.hasClass=function(a){return-1!==this.getClasses().indexOf(a)},d.prototype.addClass=function(a){if(!this.hasClass(a)){var b=this.getClasses();b.push(a),this.source.className=b.join(" ")}return this},d.prototype.removeClass=function(a){if(this.hasClass(a)){var b=this.getClasses(),c=b.indexOf(a);b.splice(c,1),this.source.className=b.join(" ")}return this},d}(),Animation=function(){function a(a){if(!OPTIONS_COORDINATES.every(function(b){return isInt(a[b])}))throw new Error('key "'+key+'" should be an integer');if(!OPTIONS_DIMENSIONS.every(function(b){var c=a[b];return isInt(c)&&0!==c}))throw new Error('key "'+key+'" should be an integer and higher than zero');if(!isArray(a.delays)||!a.delays.every(isInt))throw new Error("delays should be an array of integers")}function b(b){b=copy(b,copy(d)),a(b);var c=this;for(e.forEach(function(a){c[a]=b[a]});this.length<this.delays.length;)this.delays.push(0);this.frame=0,this.delay=0}var c=16,d={x:0,y:0,offsetX:0,offsetY:0,width:c,height:c,length:1,delays:[]},e=["x","y","offsetX","offsetY","width","height","length","delays"];return OPTIONS_COORDINATES=e.slice(0,-4),OPTIONS_DIMENSIONS=e.slice(4,-1),b.prototype.next=function(){return this.delay<this.delays[this.frame]?this.delay+1>=this.delays[this.frame]&&this.frame+1>=this.length:(this.delay=0,this.frame++,this.frame>=this.length&&(this.frame=0),!1)},b}(),SpriteSheet=function(){function a(e,g,h,i){this.name=e,f(this.name,"sprite sheet name").toBeNonBlankString(),this.offsetX=g||0,this.offsetY=h||0,this.x=0,this.y=0,this.element=new RichHTMLElement(document.createElement("div")),this.index=0,this.flipped=!1,this.animation=i?i.initial:null,this.element.source.style.backgroundImage=b+e+c,this.element.addClass(d),i=i||{},this.addAnimation=function(a,b){return f(a,"animation name").toBeNonBlankString(),f(b).toBe(Animation),i[a]=b,i.initial=i.initial||a,this.animation=a,this.redraw(),this},this.getAnimation=function(a){return i[a||this.animation]},this.clone=function(){return new a(this.name,this.offsetX,this.offsetY,i)}}var b="url('dist/i/sprites/",c=".png')",d="stage__sprite",e=d+"_style_flipped",f=check.bind(null,"SpriteSheet");return a.prototype.getFrameWidth=function(){return this.getAnimation().width},a.prototype.getFrameHeight=function(){return this.getAnimation().height},a.prototype.step=function(){return this.getAnimation().next()},a.prototype.update=function(){var a=this.getAnimation(),b=2*(a.x+a.frame*a.width),c=a.y,d=this.element.source.style;d.left=Math.floor(2*this.x+2*this.offsetX).toString()+"px",d.top=Math.floor(2*this.y+2*this.offsetY).toString()+"px",d.backgroundPosition=-b.toString()+"px "+-c.toString()+"px"},a.prototype.redraw=function(){var a=this.element.source.style,b=this.getAnimation();b.frame=0;var c=2*b.width,d=2*b.height,e=2*(b.x+b.offsetX),f=2*(b.y+b.offsetY);a.width=c.toString()+"px"||"auto",a.height=d.toString()+"px"||"auto",a.zIndex=this.index,a.backgroundPosition=-e.toString()+"px "+-f.toString()+"px"},a.prototype.flip=function(){var a=this.element.hasClass(e);this.flipped&&a?this.element.removeClass(e):this.flipped||a||this.element.addClass(e),this.flipped=!this.flipped},a}(),Action=function(){function a(a,c,d,e){this.name=a,this.source=c,this.target=d,this.data=e||null,b(this.name).toBeNonBlankString(),b(this.source).toBe(GameObject),b(this.target).toBe(GameObject)}var b=check.bind(null,"Action");return a}(),GameObject=function(){function a(a,b,c){g(b,"action listener name").toBeNonBlankString(),g(c,"action callback").toBeFunction();var d=a[b];void 0!==d?d.push(c):d=[c],a[b]=d}function b(a,b){function c(a){var e=d[a];return function(){a<d.length&&e(b,c(a+1))}}var d=a[b.name];if(!this.disabled){g(b).toBe(Action);var e=d[0];void 0!==d?d.length>1?e(b,c(1)):e(b):console.warn("Couldn't find an action listener for \""+b.name+'"')}}function c(c,d,e,f,h){this.name=c,this.sprite=d,this.scroll=e||0,this.hitWidth=f||0,this.disabled=h||!1,g(this.name,"name").toBeNonBlankString(),g(this.sprite).toBe(SpriteSheet),g(this.scroll,"scroll").toBePositiveInt(),g(this.hitWidth,"hit width").toBePositiveInt(),g(this.disabled,"disabled").toBeBoolean();var i={};this.addActionListener=a.bind(this,i),this.receiveAction=b.bind(this,i)}var d=320,e=112,f=6,g=check.bind(null,"GameObject");return c.prototype.getHitWidth=function(){return this.hitWidth?this.hitWidth:Math.floor(this.sprite.getFrameWidth()/2)},c.prototype.getDeltaWidth=function(){return d/2-Math.ceil(this.sprite.getFrameWidth()/2)},c.prototype.getDeltaHeight=function(){return e/2-Math.ceil(this.sprite.getFrameHeight()/2)},c.prototype.leftCornerReached=function(){return this.scroll<d/2},c.prototype.rightCornerReached=function(a){return this.scroll>a-d/2},c.prototype.correctPosition=function(a,b){b&&g(b).toBe(c);var h=!1,i=this.getHitWidth();(this.scroll<i+1||this.scroll>this.bound-i)&&(h=!0,this.scroll=Math.min(this.bound-i,Math.max(i+1,this.scroll))),this.sprite.y=e-this.sprite.getFrameHeight()-f;var j=Math.floor(this.scroll)-a+d-Math.ceil(this.sprite.getFrameWidth()/2),k=Math.floor(this.scroll)-Math.ceil(this.sprite.getFrameWidth()/2);return this.sprite.x=b?b.leftCornerReached()||b.rightCornerReached(a)?b.rightCornerReached(a)?j:k:this.getDeltaWidth()-Math.floor(b.scroll-this.scroll):this.leftCornerReached()||this.rightCornerReached(a)?this.rightCornerReached(a)?j:k:this.getDeltaWidth(),this.sprite.update(),h},c.prototype.createAction=function(a,b){return g(a,"name").toBeNonBlankString(),new Action(a,this,b)},c}(),DynamicObject=function(){"use strict";function a(a){if(!isNumber(a.step))throw new Error('velocity with invalid step"');if(!isNumber(a.step))throw new Error('velocity with invalid maximum"')}function b(c,f,g,h,i,j){b.superclass.constructor.apply(this,[c,f,g,h,!1]),this.velocity={step:i||d,max:j||e,value:0},a(this.velocity)}var c=.6,d=.4,e=3;return inherits(b,GameObject),b.prototype.correctPosition=function(){var a=b.superclass.correctPosition.apply(this,arguments);a&&(this.velocity.value=0)},b.prototype.pull=function(a,b){if(a=a||1,b=b||this.velocity.step,!isNumber(a))throw new Error('pull with invalid factor"');if(!isNumber(b))throw new Error('pull with invalid value"');b*=a;var c=this.velocity;c.value+=b,c.value=Math.min(c.max,Math.abs(c.value))*(Math.abs(c.value)/(c.value||1)),this.scroll-=c.value;var d=this.sprite.flipped;(0>a&&d||a>0&&!d)&&this.sprite.flip(),this.correctAnimation()},b.prototype.wait=function(){this.velocity.value*=c,Math.abs(this.velocity.value)<.1&&(this.velocity.value=0),this.scroll-=this.velocity.value,this.correctAnimation()},b.prototype.correctAnimation=function(){var a=this.sprite.animation;Math.abs(this.velocity.value)<1&&"walk"===this.sprite.animation&&(this.sprite.animation="idle"),Math.abs(this.velocity.value)>=1&&"idle"===this.sprite.animation&&(this.sprite.animation="walk"),a!=this.sprite.animation&&this.sprite.redraw()},b}(),Room=function(){function a(a,b){for(var c=[],d=0;a>d;++d){{var h=document.createElement("div");1===a?b:b+"_"+d.toString()}h.style.backgroundImage=e+b+f,h.setAttribute("class",g),c.push(h)}return c}function b(b,e,f,g,i){this.name=b,this.type=e||d,this.width=f||c,this.depth=g||1,h(this.name).toBeNonBlankString(),h(this.type).toBeNonBlankString(),h(this.width).toBePositiveInt(),h(this.depth).toBePositiveInt(),this.width=Math.max(c,this.width),this.tiles=a(this.depth,this.type),this.objects=i||[],h(this.objects).toBeListOf(GameObject)}var c=320,d="base",e="url('dist/i/tiles/",f=".png')",g="background__tile",h=check.bind(null,"Room");return b.prototype.updateTiles=function(a){return isInt(a)?void this.tiles.forEach(function(b,c,d){var e=2*-Math.floor(a/(d.length-c));b.style.backgroundPosition=e.toString()+"px 0px"}):new Error("offset should be an integer")},b}(),Checker=function(){function a(a,b,d){if(this.source=a,this.target=b,this.name=d||"null",!isValidString(this.source))throw new Error('Checker: "source" '+c);if(!isValidString(this.name))throw new Error('Checker: "name" '+c)}var b={Animation:Animation,SpriteSheet:SpriteSheet,Action:Action,GameObject:GameObject,Room:Room},c="value should be a non blank string",d="value should be an integer",e='value cannot be lower than zero"',f="value should be a boolean",g="should be a function",h="should be an array";return a.findNameOf=function(a){for(var c in b){if(b[c]===a)return c;if(a instanceof b[c])return c}return"Unknown"},a.prototype.is=function(a){return this.target instanceof a},a.prototype.toBe=function(b){var c=a.findNameOf(b),d=a.findNameOf(this.target);if(!this.is(b))throw console.info(this.target),new Error(this.source+': expected "'+c+'", got "'+d+'"')},a.prototype.toBeListOf=function(b){function c(a){return a instanceof b}var d=a.findNameOf(b),e=this.target;if(!isArray(e)||isArray(e)&&e.length>0&&!e.every(c))throw console.info(this.target),new Error(this.source+': expected list of "'+d+'"')},a.prototype.toBePositiveInt=function(){if(!isInt(this.target))throw new Error(this.source+': "'+this.name+'" '+d);if(this.target<0)throw new Error(this.source+': "'+this.name+'" '+e)},a.prototype.toBeBoolean=function(){if(!isBoolean(this.target))throw new Error(this.source+': "'+this.name+'" '+f)},a.prototype.toBeNonBlankString=function(){if(!isValidString(this.target))throw new Error(this.source+': "'+this.name+'" '+c)},a.prototype.toBeFunction=function(){if(!isFunction(this.target))throw new Error(this.source+': "'+this.name+'" '+g)},a.prototype.toBeArray=function(){if(!isArray(this.target))throw new Error(this.source+': "'+this.name+'" '+h)},a.prototype.toBePresentIn=function(a){if(!isArray(a))throw new Error('Checker: "list" '+h);if(!contains(a,this.target))throw console.error(this.source+": couldn't find",this.target,"in",a),new Error(this.source+": not found")},a}(),keys=function(){function a(a){return 87===a||38===a?"up":68===a||39===a?"right":83===a||40===a?"down":65===a||37===a?"left":void 0}function b(b){var c=a(b.keyCode);-1===d.indexOf(c)&&d.push(c)}function c(b){var c=d.indexOf(a(b.keyCode));-1!==c&&d.splice(c,1)}var d=[];return{bindTo:function(a){a.addEventListener("keydown",b),a.addEventListener("keyup",c)},getLast:function(){return d[d.length-1]},hasKey:function(a){return contains(d,a)}}}(),gameScreen=function(){function a(a,b){var c=i.filter(function(b){var c=a.scroll>=b.scroll-b.getHitWidth(),d=a.scroll+a.getHitWidth()<=b.scroll+b.getHitWidth();return c&&d&&b!==a})[0];c&&c.receiveAction(a.createAction(b,c))}function b(){switch(keys.getLast()){case"right":j.pull(-1);break;case"left":j.pull();break;case"down":m||a(j,"interact"),j.wait();break;default:j.wait()}m=keys.hasKey("down")}function c(){new Array(l.source,background.source).forEach(function(a){for(;a.firstChild;)a.removeChild(a.firstChild)})}function d(a){if(a>=g.length)throw new Error("Game screen: room index is out of range");c(),h=a,i=[];var b=g[h];Array.prototype.push.apply(i,b.objects.slice()),i.push(j),i.forEach(function(a){a.bound=b.width,a.sprite.redraw()}),b.tiles.forEach(function(a){background.append(a)}),l.append(j.sprite.element)}var e=320,f=112,g=[],h=0,i=[],j=null,k=new RichHTMLElement("div"),l=new RichHTMLElement("div");background=new RichHTMLElement("div");new RichHTMLElement("div"),new RichHTMLElement("div");l.addClass("stage"),background.addClass("background"),k.attr("id","screen"),k.attr("tabindex",0),k.append(l.source),k.append(background.source),keys.bindTo(k.source);var m=!1,n=check.bind(null,"Game screen");return{load:function(a,b,c){g=a,j=c,b=b,n(g,"room list").toBeListOf(Room),n(j,"active object").toBe(GameObject),n(b,"spawn").toBePositiveInt(),j.scroll=b,j.sprite.index=1,d(0)},change:function(a,b){n(a,"index").toBePositiveInt(),n(b,"scroll").toBePositiveInt(),j.scroll=b,d(a)},prompt:function(a,b){console.log("works"),b&&(n(b,"callback").toBeFunction(),b())},next:function(){b();var a=g[h],c=l.children();i.forEach(function(b){b.correctPosition(a.width,b===j?null:j),b.sprite.step(),b.sprite.update();var d=b.sprite.x,g=b.sprite.y,h=b.sprite.getFrameWidth(),i=b.sprite.getFrameHeight(),k=0>d+h||d>=e||0>g+i||g>=f,m=b.sprite.element;k&&contains(c,m)?l.remove(m):k||contains(c,m)||l.append(m)});var d=j.scroll;j.leftCornerReached()?d=0:j.rightCornerReached(a.width)&&(d=a.width),a.updateTiles(Math.floor(d))},getContainer:function(){return k}}}(),XML_CONFIG='<level spawn="600">	<room name="hall" width="840">		<object sprite="door" scroll="40" disabled="true">		</object>		<object sprite="door" scroll="400">			<action name="interact" type="prompt">				lorem ipsum motherfucker 1			</action>			<action name="interact" type="prompt">				lorem ipsum motherfucker 2			</action>			<action name="interact" type="level" index="1" scroll="240">			</action>		</object>		<object sprite="door" scroll="780" disabled="true">		</object>	</room>	<room width="320" type="red">		<object sprite="door" scroll="240">			<action name="interact" type="level" index="0" scroll="400">			</action>		</object>	</room></level>',SPRITES={};SPRITES.hero=new SpriteSheet("hero").addAnimation("idle",new Animation({width:37,height:72})).addAnimation("walk",new Animation({x:37,width:37,height:72,length:16})),SPRITES.door=new SpriteSheet("door",0,-10).addAnimation("idle",new Animation({width:40,height:80}));var XMLHelper=function(){function a(a){return toArray(a.attributes).reduce(function(a,b){return a[toCamelCase(b.name)]=b.value,a},{})}function b(b){var c=a(b),d=c.type;switch(i(d,"type").toBePresentIn(h),d){case"level":var e=isDefined(c.index)?parseFloat(c.index):0,f=isDefined(c.scroll)?parseFloat(c.scroll):0;return i(e,"index").toBePositiveInt(),i(f,"scroll").toBePositiveInt(),function(a,b){gameScreen.change(e,f),b&&(i(b,"callback").toBeFunction(),b())};case"prompt":return function(a,b){var c="derp";gameScreen.prompt(c,b)}}}function c(c,d){var e=a(c),h=e.name||"#"+d.toString(),j=e.sprite,k=isDefined(e.scroll)?parseFloat(e.scroll):null,l=e.hitWidth||null,m=isDefined(e.disabled)?parseBoolean(e.disabled):null;i(j,"sprite").toBeNonBlankString();var n=SPRITES[j],o=new GameObject(h,n.clone(),k,l,m);return toArray(c.childNodes).forEach(function(a){var c=a.attributes.name.value||g;i(c,"name").toBePresentIn(f),o.addActionListener(c,b(a))}),o}function d(b,d){var e=a(b),f=e.name||"#"+d.toString(),g=e.type||null,h=isDefined(e.width)?parseFloat(e.width):0,i=isDefined(e.depth)?parseFloat(e.depth):0,j=toArray(b.childNodes).map(c);return new Room(f,g,h,i,j)}function e(a){var b=new Object;return a.attributes.spawn&&(b.spawn=parseFloat(a.attributes.spawn.value),i(b.spawn,"spawn").toBePositiveInt()),b.rooms=toArray(a.childNodes).map(d),b}var f=["interact"],g=f[0],h=["level","prompt"],i=check.bind(null,"XML Helper");return{parse:function(a){var b;if(a=a.replace(/\t+/g,""),window.DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml")}else b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a);return e(b.getElementsByTagName("level")[0])}}}();!function(){var a=80,b=new RichHTMLElement(document.body);b.append(gameScreen.getContainer());var c=new DynamicObject("hero",SPRITES.hero.clone(),0,8,!1),d=XMLHelper.parse(XML_CONFIG);gameScreen.load(d.rooms,d.spawn,c),setInterval(gameScreen.next,a)}();